---
title: "Fpoptest"
author: "SaÃ¢d Qriouet"
date: "5/13/2021"
output: html_document
---



```{r}
muit <- function(data,i,t)
{
  long  <- t-i+1
  return (sum(data[i:t])/long)
}
```


```{r}
testmuit <- c(0,0,1)
muit(testmuit,1,3)
mean(testmuit)
```


```{r}
Vit <- function(data, i = 1, t = length(data))
{
  long  <- t-i+1
  s2 <- sum(data[i:t]^2)
  if (long == 1) {res <- 0} else {res <- s2/long - (muit(data,i,t))^2}
  return (res)
}
```


```{r}
testvit <- c(0,1,1,4)
Vit(testvit,1,4)
var(testvit)*3/4

Vit(c(4,5))
var(c(4,5))*3/4

```


```{r}
quad <- function(data, i, t, beta, theta = data[t])
{
  res <- mt(data, i-1) + beta + (t-i+1)*((theta - muit(data, i, t))^2 + Vit(data, i, t))
  return(res) 
}
```



```{r}
mit <- function(data, i, t, beta)
{
  long <- t - i + 1
  return (long*Vit(data, i, t) + mt(data,i-1, beta) + beta)
}
```


```{r}
mt <- function(data, t, beta)
{
  val_min <- - beta
  for (i in 2:t)
  {
    a <- mit(data, i, t, beta)
      if (a < val_min)
      {
        val_min <- a
        arg_min <- i - 1
      }
  }
  return(list(valmin = val_min, argmin = arg_min))
}
```

```{r}
getValue <- function(data, t, beta)
{
  return(mt(data, t, beta)$valmin)
}
```



```{r}
getLabel <- function(data, t, beta)
{
  return(mt(data, t, beta)$argmin)
}

#### OR ??
#getLabel <- function(v[t])
#{
#  return(v[t]$label)
#}

#### OR Backtracking ?

```


```{r}
prune <- function(v, t, beta)
{
  for (i in (1:t)){
      if (v[i] > getValue(v, t, beta) + beta){
        v <- v[v!= i]}}
  }
  return(v)
}

## OR
#prune <- function(data, v, t, beta)
#{
#    for (i in (1:t)){
#      if ((t - i + 1 )*Vit(data, i, t) > mt(data, t, beta) - mt(data, i-1, beta)){
#        v <- v[v!= i]}}
#  }
#  return(v)
#}
```



```{r}
myFPOP1D <- function(data, cost = "gauss", beta = best_beta(data))
{
  allowed.cost <- c("gauss", "poisson")
  if(!cost %in% allowed.cost){stop('type must be one of: ', paste(allowed.cost, collapse=", "))}

  if (cost == "gauss") {cost_f <- cost_gauss}
  else if (cost == "poisson") {cost_f <- cost_poiss}

  n <- length(data)
  m <- -beta

  tau <- rep(0,n)
  v <- NULL

  for (t in 2:n)
  {
    getV <- getValue(v, t-1, beta)
    u <- list(label = t, value = getV + beta, position = data[t])
    v[t-1] <- list(v[t-1], u)
    
    v[t] <- v[t-1] # adding the new data point yt
    thetastar <- mean(data[1:t])
    v[t] <- list(v[t], quad(data, t, t, beta, data[t])) # adding intersection point new quadratic     qtt vs old ones qti
    
    v[t] <- sort(v[1:t]) # sort with R function
    v[t] <- prune(v[1:t]) # pruning
    
    tau[t] <- getLabel(data, t, beta) # label of the smallest element
    
    # backtracking
    s <- tau[n]
    P <- tau[n]
    
    while (s)
    {
      P <- c(P, cp[s])
      s <- cp[s]
    }
    P <- rev(P)[-1]
    
  }


  return(list(changepoints = P, mean = NULL, globalCost = v[n] - length(P)*beta))
}
```

