---
title: "Fpoptest"
author: "Saâd Qriouet"
date: "5/13/2021"
output: html_document
---

```{r}
devtools::install_github("Qrtsaad/CHANGEPOINT", force = TRUE)
library(CHANGEPOINT)
```




```{r}
muit <- function(data,i = 1, t = length(data))
{
  long  <- t-i+1
  return (sum(data[i:t])/long)
}
```


```{r}
testmuit <- c(0,0,1)
muit(testmuit,1,3)
mean(testmuit)
```


```{r}
Vit <- function(data, i = 1, t = length(data))
{
  long  <- t-i+1
  s2 <- sum(data[i:t]^2)
  if (long == 1) {res <- 0} else {res <- s2/long - (muit(data,i,t))^2}
  return (res)
}
```


```{r}
testvit <- c(0,1,1,4)
Vit(testvit,1,4)
var(testvit)*3/4

Vit(c(4,5))
var(c(4,5))*1/2

```


```{r}
quad <- function(data, i = 1, t = length(data), beta = best_beta(data), theta = data[t])
{
  res <- mt(data, i-1, beta)$valmin + beta + (t-i+1)*((theta - muit(data, i, t))^2 + Vit(data, i, t))
  return(res) 
}
```



```{r}
## NON UTILISÉ
mit <- function(data, i, t, beta)
{
  long <- t - i + 1
  return (long*Vit(data, i, t) + mt(data,i-1, beta) + beta)
}
```




```{r}
mt <- function(data, t = length(data), beta = best_beta(data))
{

  if (t==0){return (list(valmin = -beta, argmin = 0))}
  else {
    val_min <- - beta
    arg_min <- 0
    for (i in 1:t)
    {
      val_min <- t*Vit(data, 1, t) + mt(data, 0, beta)$valmin + beta
      for (j in 1:i)
      {  
        a <- (t-i+1)*Vit(data, i, t) + mt(data, i-1, beta)$valmin + beta
          if (a <= val_min)
          {
            val_min <- a
            arg_min <- j-1
          }
      }
    }
    return(list(valmin = val_min, argmin = arg_min))
  }
}
```




```{r}
getValue <- function(data, t = length(data), beta = best_beta(data))
{
  return(mt(data, t, beta)$valmin)
}
```



```{r}
getLabel <- function(data, t = length(data), beta = best_beta(data))
{
  return(mt(data, t, beta)$argmin)
}

#### OR ??
#getLabel <- function(v[t])
#{
#  return(v[t]$label)
#}

#### OR Backtracking ?

```


```{r}
prune <- function(v, t = length(v), beta = best_beta(data))
{
  for (i in (1:t)){
      if (v[i] > getValue(v, t, beta) + beta){
        v <- v[v!= i]}
  }
  return(v)
}

## OR
#prune <- function(data, v, t, beta)
#{
#    for (i in (1:t)){
#      if ((t - i + 1 )*Vit(data, i, t) > mt(data, t, beta) - mt(data, i-1, beta)){
#        v <- v[v!= i]}}
#  }
#  return(v)
#}
```


```{r}
mybacktracking <- function(vect)
{
  n <- length(vect)
  v <- vect[n]
  P <- vect[n]

  while (v > 0)
  {
    P <- c(P, vect[v])
    v <- vect[v]
  }
  P <- rev(P)[-1]
  
  return(changepoints = P)
}
```

```{r}
test <- c(0,1,1,1,2,3,4,5,6,6,6,6,9)
mybacktracking(test)
```




```{r}
myFPOP1D <- function(data, cost = "gauss", beta = best_beta(data))
{
  allowed.cost <- c("gauss", "poisson")
  if(!cost %in% allowed.cost){stop('type must be one of: ', paste(allowed.cost, collapse=", "))}

  if (cost == "gauss") {cost_f <- cost_gauss}
  else if (cost == "poisson") {cost_f <- cost_poiss}

  n <- length(data)
  m <- -beta

  tau <- rep(0,n)
  v <- NULL

  for (t in 1:n)
  {
    # line 5
    getV <- getValue(v, t-1, beta)
    u <- list(label = t, value = getV + beta, position = data[t])
    v[t-1] <- list(v[t-1], u)
    
    # line 7
    v[t] <- v[t-1] # adding the new data point yt
    
    #line 8
    thetastar <- mean(data[1:t])
    v[t] <- list(v[t], quad(data, t, t, beta, data[t])) # adding intersection point new quadratic     qtt vs old ones qti
    
    # line 10
    #v[t] <- sort(v[1:t]) # sort with R function
    
    #line 11
    v[t] <- prune(v,t,beta) # pruning
    
    
    # line 12
    tau[t] <- getLabel(v[t], t, beta) # label of the smallest element
    
    
    
    
    # backtracking
    #P <- mybacktracking(tau)
    
    s <- tau[n]
    P <- tau[n]
    
    while (s>0)
    {
      P <- c(P, cp[s])
      s <- cp[s]
    }
    P <- rev(P)[-1]
  }


  return(list(changepoints = P, mean = NULL, globalCost = v[n] - length(P)*beta))
}
```




```{r}
test <- c(0,1,1,4,4,4,5,5,9)
myFPOP1D(test)
```


```{r}
## en cours


myFpopbis <- function(data, cost = "gauss", beta = best_beta(data))
{
  allowed.cost <- c("gauss", "poisson")
  if(!cost %in% allowed.cost){stop('type must be one of: ', paste(allowed.cost, collapse=", "))}

  if (cost == "gauss") {cost_f <- cost_gauss}
  else if (cost == "poisson") {cost_f <- cost_poiss}
  
  n <- length(data)
  
  tau <- rep(0,n)
  v <- rep(0,n)
  
  for (t in 1:n){
    u <- list(label = t, value = mt(data, t-1)$valmin + beta , position = data[t])
    v[t-1] <- list(v[t-1],u)
  }
  
  
  
  
  
  
  return(v)
}
```

```{r}
vectt <- c(0,1,1,1,4,4,7,7,8,9)
myFpopbis(vectt)
```

